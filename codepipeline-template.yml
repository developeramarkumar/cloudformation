AWSTemplateFormatVersion: "2010-09-09"
Parameters:
  GitHubToken:
    Type: AWS::SSM::Parameter::Value<String>
    Default: /GitHub/AccessToken

Resources:
  YourCodePipelineRole:
    Type: "AWS::IAM::Role"
    Properties:
      RoleName: YourCodePipelineRole
      AssumeRolePolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Principal:
              Service: "codepipeline.amazonaws.com"
            Action: "sts:AssumeRole"

  YourCodePipelinePolicy:
    Type: "AWS::IAM::ManagedPolicy"
    Properties:
      PolicyName: YourCodePipelinePolicy
      PolicyDocument:
        Version: "2012-10-17"
        Statement:
          - Effect: "Allow"
            Action:
              - "codepipeline:StartPipelineExecution"
              - "codepipeline:GetPipelineState"
              - "codepipeline:GetPipeline"
            Resource: "arn:aws:codepipeline:REGION:ACCOUNT_ID:your-pipeline-name"

          - Effect: "Allow"
            Action:
              - "s3:GetObject"
              - "s3:GetObjectVersion"
              - "s3:PutObject"
            Resource:
              - "arn:aws:s3:::your-source-bucket/*"
              - "arn:aws:s3:::your-artifact-bucket/*"

          - Effect: "Allow"
            Action:
              - "cloudformation:CreateChangeSet"
              - "cloudformation:ExecuteChangeSet"
              - "cloudformation:GetChangeSet"
              - "cloudformation:DescribeChangeSet"
              - "cloudformation:DescribeStacks"
              - "cloudformation:DescribeStackEvents"
              - "cloudformation:CreateStack"
              - "cloudformation:UpdateStack"
            Resource: "arn:aws:cloudformation:REGION:ACCOUNT_ID:stack/your-stack-name/*"
